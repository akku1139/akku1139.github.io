<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
<!--
TODO:

support clr register
https://github.com/TeamYogaBlade2/android_kernel_lenovo_b8000-new/blob/2786f5ec4b1ce613ce68de2886e68820154f0e4e/mediatek/platform/mt6589/kernel/core/mt_clkmgr.c#L2220
-->
    <title>Clock Dump Viewer - Grid Layout</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f0f2f5; }
        textarea { width: 100%; height: 120px; font-family: monospace; margin-bottom: 20px; padding: 10px; box-sizing: border-box; }
        
        .cg-container { 
            background: white; 
            margin-bottom: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .cg-header { 
            background: #444; 
            color: white; 
            padding: 8px 15px; 
            font-weight: bold; 
            display: flex;
            justify-content: space-between;
        }
        
        .clk-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr); /* 16列で折り返し */
            border-top: 1px solid #ddd;
        }
        
        .clk-cell {
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            min-width: 60px;
            text-align: center;
            font-size: 11px;
        }
        .clk-name {
            background: #f8f9fa;
            padding: 5px 2px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }
        .clk-state {
            padding: 8px 2px;
            font-weight: bold;
        }
        
        /* 状態別カラー */
        .on { background-color: #e3f2fd; color: #0d47a1; }
        .off { background-color: #f5f5f5; color: #9e9e9e; }
        .unused { color: #ddd; font-weight: normal; }
    </style>
</head>
<body>

<h3>Clock Register Dump Input</h3>
<textarea id="clkInput" placeholder="Paste /proc/clkmgr/clk_test output here..."></textarea>

<div id="displayArea"></div>

<script>
const clks = {
    "CG_PERI0": ["nfi","therm","pwm1","pwm2","pwm3","pwm4","pwm5","pwm6","pwm7","pwm","usb0","usb1","apdma","msdc0","msdc1","msdc2","msdc3","msdc4","aphif","mdhif","nli","irda","uart0","uart1","uart2","uart3","i2c0","i2c1","i2c2","i2c3","i2c4","i2c5"],
    "CG_PERI1": ["i2c6","wrap","auxadc","spi1","fhctl",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_INFRA": ["dbgclk","smi","spi0",null,null,"audio","cec","mfgaxi","m4u","md1mcuaxi","md1hwmixaxi","md1ahb","md2mcuaxi","md2hwmixaxi","md2ahb","cpum","kp",null,null,null,"ccif0","ccif1","pmicspi","pmicwrap",null,null,null,null,null,null,null,null],
    "CG_TOPCK": ["pmicspi",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_DISP0": [null,null,null,"scl",null,null,"color","2dshp","bls",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_DISP1": [null,null,null,null,null,null,"dpi0","dpi1","lcd","slcd",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_IMAGE": [null,null,null,null,null,null,null,null,null,null,null,null,null,"fpc",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_MFG": ["axi","mem","g3d","hyd",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_AUDIO": [null,null,"afe",null,null,null,"i2s",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_VDEC0": ["vde",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_VDEC1": ["smi",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
    "CG_VENC": ["ven",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]
};

const PWR_DOWN = 0;
const PWR_ON = 1;

const createMask = (bit) => 1 << bit;
const generalClkGetState = (regValue, mask) => (regValue & mask) ? PWR_DOWN : PWR_ON;
const simpleClkGetState = (regValue, mask) => (regValue & mask) ? PWR_ON : PWR_DOWN;

const parseClockRegisters = (text) => {
    const result = {};
    const regex = /\[CG_([^\]\s]+)\s*\]=\[(0x[0-9a-fA-F]+)\]/g;
    let match;
    while ((match = regex.exec(text)) !== null) {
        result[`CG_${match[1].trim()}`] = parseInt(match[2], 16);
    }
    return result;
};

const textarea = document.getElementById('clkInput');
const displayArea = document.getElementById('displayArea');

textarea.addEventListener('input', (e) => {
    const parsedData = parseClockRegisters(e.target.value);
    renderBlocks(parsedData);
});

function renderBlocks(parsedData) {
    displayArea.innerHTML = '';
    
    Object.keys(clks).forEach(regName => {
        const regValue = parsedData[regName];
        if (regValue === undefined) return;

        const container = document.createElement('div');
        container.className = 'cg-container';
        
        const header = document.createElement('div');
        header.className = 'cg-header';
        header.innerHTML = `<span>${regName}</span><span>0x${regValue.toString(16).padStart(8, '0')}</span>`;
        container.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'clk-grid';

        clks[regName].forEach((clkName, bitIndex) => {
            const mask = createMask(bitIndex);
            const isSpecial = regName.includes("VDEC") || regName.includes("VENC");
            const state = isSpecial ? simpleClkGetState(regValue, mask) : generalClkGetState(regValue, mask);
            
            const cell = document.createElement('div');
            cell.className = `clk-cell ${clkName ? (state === PWR_ON ? 'on' : 'off') : 'unused'}`;
            
            cell.innerHTML = `
                <div class="clk-name" title="Bit ${bitIndex}">${clkName || '-'}</div>
                <div class="clk-state">${clkName ? (state === PWR_ON ? 'ON' : 'OFF') : bitIndex}</div>
            `;
            grid.appendChild(cell);
        });

        container.appendChild(grid);
        displayArea.appendChild(container);
    });
}
</script>
</body>
</html>
